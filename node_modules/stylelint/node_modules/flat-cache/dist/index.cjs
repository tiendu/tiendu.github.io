"use strict";var F=Object.create;var u=Object.defineProperty;var O=Object.getOwnPropertyDescriptor;var C=Object.getOwnPropertyNames;var L=Object.getPrototypeOf,k=Object.prototype.hasOwnProperty;var A=(s,e)=>{for(var t in e)u(s,t,{get:e[t],enumerable:!0})},y=(s,e,t,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of C(e))!k.call(s,i)&&i!==t&&u(s,i,{get:()=>e[i],enumerable:!(r=O(e,i))||r.enumerable});return s};var g=(s,e,t)=>(t=s!=null?F(L(s)):{},y(e||!s||!s.__esModule?u(t,"default",{value:s,enumerable:!0}):t,s)),P=s=>y(u({},"__esModule",{value:!0}),s);var T={};A(T,{FlatCache:()=>l,FlatCacheEvents:()=>S,clearAll:()=>E,clearCacheById:()=>x,create:()=>I,createFromFile:()=>R,default:()=>p});module.exports=P(T);var a=g(require("fs"),1),o=g(require("path"),1),v=require("cacheable"),m=require("flatted"),b=require("hookified"),S=(h=>(h.SAVE="save",h.LOAD="load",h.DELETE="delete",h.CLEAR="clear",h.DESTROY="destroy",h.ERROR="error",h.EXPIRED="expired",h))(S||{}),l=class extends b.Hookified{_cache=new v.CacheableMemory;_cacheDir=".cache";_cacheId="cache1";_persistInterval=0;_persistTimer;_changesSinceLastSave=!1;_parse=m.parse;_stringify=m.stringify;constructor(e){super(),e&&(this._cache=new v.CacheableMemory({ttl:e.ttl,useClone:e.useClone,lruSize:e.lruSize,checkInterval:e.expirationInterval})),e?.cacheDir&&(this._cacheDir=e.cacheDir),e?.cacheId&&(this._cacheId=e.cacheId),e?.persistInterval&&(this._persistInterval=e.persistInterval,this.startAutoPersist()),e?.deserialize&&(this._parse=e.deserialize),e?.serialize&&(this._stringify=e.serialize)}get cache(){return this._cache}get cacheDir(){return this._cacheDir}set cacheDir(e){this._cacheDir=e}get cacheId(){return this._cacheId}set cacheId(e){this._cacheId=e}get changesSinceLastSave(){return this._changesSinceLastSave}get persistInterval(){return this._persistInterval}set persistInterval(e){this._persistInterval=e}load(e,t){try{let r=o.default.resolve(`${t??this._cacheDir}/${e??this._cacheId}`);this.loadFile(r),this.emit("load")}catch(r){this.emit("error",r)}}loadFile(e){if(a.default.existsSync(e)){let t=a.default.readFileSync(e,"utf8"),r=this._parse(t);if(Array.isArray(r))for(let i of r)i&&typeof i=="object"&&"key"in i&&(i.expires?this._cache.set(i.key,i.value,{expire:i.expires}):i.timestamp?this._cache.set(i.key,i.value,{expire:i.timestamp}):this._cache.set(i.key,i.value));else for(let i of Object.keys(r)){let c=r[i];c&&typeof c=="object"&&"key"in c?this._cache.set(c.key,c.value,{expire:c.expires}):c&&typeof c=="object"&&c.timestamp?this._cache.set(i,c,{expire:c.timestamp}):this._cache.set(i,c)}this._changesSinceLastSave=!0}}loadFileStream(e,t,r,i){if(a.default.existsSync(e)){let D=a.default.statSync(e).size,h=0,d="",f=a.default.createReadStream(e,{encoding:"utf8"});f.on("data",n=>{h+=n.length,d+=n,t(h,D)}),f.on("end",()=>{let n=this._parse(d);for(let _ of Object.keys(n))this._cache.set(n[_].key,n[_].value,{expire:n[_].expires});this._changesSinceLastSave=!0,r()}),f.on("error",n=>{this.emit("error",n),i&&i(n)})}else{let c=new Error(`Cache file ${e} does not exist`);this.emit("error",c),i&&i(c)}}all(){let e={},t=[...this._cache.items];for(let r of t)e[r.key]=r.value;return e}get items(){return[...this._cache.items]}get cacheFilePath(){return o.default.resolve(`${this._cacheDir}/${this._cacheId}`)}get cacheDirPath(){return o.default.resolve(this._cacheDir)}keys(){return[...this._cache.keys]}setKey(e,t,r){this.set(e,t,r)}set(e,t,r){this._cache.set(e,t,r),this._changesSinceLastSave=!0}removeKey(e){this.delete(e)}delete(e){this._cache.delete(e),this._changesSinceLastSave=!0,this.emit("delete",e)}getKey(e){return this.get(e)}get(e){return this._cache.get(e)}clear(){try{this._cache.clear(),this._changesSinceLastSave=!0,this.save(),this.emit("clear")}catch(e){this.emit("error",e)}}save(e=!1){try{if(this._changesSinceLastSave||e){let t=this.cacheFilePath,r=[...this._cache.items],i=this._stringify(r);a.default.existsSync(this._cacheDir)||a.default.mkdirSync(this._cacheDir,{recursive:!0}),a.default.writeFileSync(t,i),this._changesSinceLastSave=!1,this.emit("save")}}catch(t){this.emit("error",t)}}removeCacheFile(){try{if(a.default.existsSync(this.cacheFilePath))return a.default.rmSync(this.cacheFilePath),!0}catch(e){this.emit("error",e)}return!1}destroy(e=!1){try{this._cache.clear(),this.stopAutoPersist(),e?a.default.rmSync(this.cacheDirPath,{recursive:!0,force:!0}):a.default.rmSync(this.cacheFilePath,{recursive:!0,force:!0}),this._changesSinceLastSave=!1,this.emit("destroy")}catch(t){this.emit("error",t)}}startAutoPersist(){this._persistInterval>0&&(this._persistTimer&&(clearInterval(this._persistTimer),this._persistTimer=void 0),this._persistTimer=setInterval(()=>{this.save()},this._persistInterval))}stopAutoPersist(){this._persistTimer&&(clearInterval(this._persistTimer),this._persistTimer=void 0)}},p=class{static create=I;static createFromFile=R;static clearCacheById=x;static clearAll=E};function I(s){let e=new l(s);return e.load(),e}function R(s,e){let t=new l(e);return t.loadFile(s),t}function x(s,e){new l({cacheId:s,cacheDir:e}).destroy()}function E(s){a.default.rmSync(s??".cache",{recursive:!0,force:!0})}0&&(module.exports={FlatCache,FlatCacheEvents,clearAll,clearCacheById,create,createFromFile});
